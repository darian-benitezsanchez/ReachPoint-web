<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ReachPoint</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="./favicon.ico" />
    <link rel="stylesheet" href="./styles.css" />
    <!-- bcryptjs for client-side hash comparison (used by Login-Screen.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js" defer></script>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">ReachPoint</div>
      <nav class="nav" id="mainNav">
        <a href="#/dashboard">Dashboard</a>
        <a href="#/create">New Campaign</a>
      </nav>
    </header>

    <main id="app"></main>

    <!-- SPA bootloader: preserves your current routing while wiring the Login screen -->
    <script type="module">
      const SESSION_KEY = 'rpAuth';
      const navEl = document.getElementById('mainNav');

      function isAuthed() {
        return !!sessionStorage.getItem(SESSION_KEY);
      }

      // Decide which module to load based on auth + route
      async function boot() {
        const authed = isAuthed();

        // If not authenticated, hide nav and force login route
        if (!authed) {
          if (navEl) navEl.style.display = 'none';
          if (location.hash !== '#/login') location.hash = '#/login';
          await import('./screens/Login-Screen.js'); // renders into #app
          return;
        }

        // Authenticated: show nav and ensure a default route
        if (navEl) navEl.style.display = '';
        if (!location.hash || location.hash === '#/login') {
          location.hash = '#/dashboard';
        }

        // Load your existing SPA/router as before
        await import('./app.js');
      }

      // Re-run boot when the hash changes (simple guard)
      window.addEventListener('hashchange', () => {
        const authed = isAuthed();

        // Block any non-login route if not authed
        if (!authed && location.hash !== '#/login') {
          location.hash = '#/login';
        }

        // Toggle nav visibility based on auth
        if (navEl) navEl.style.display = authed ? '' : 'none';

        // Allow app.js (router) to handle route changes once authed.
        // If we just became unauthenticated (e.g., after a logout implemented in app.js),
        // Login-Screen will take over on the next boot call.
        boot();
      });

      // Initial boot
      boot();
    </script>

    <!-- Important: must be served over HTTP(S), not file:// -->
    <!-- Note: app.js is now loaded dynamically by the boot script above to preserve auth routing -->
  </body>
</html>
